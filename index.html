<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaintBench 2.0 - Pro Painter Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { background-color: #f8f8f8; font-family: 'Inter', 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        .brutal-card { border: 3px solid #000; transition: all 0.2s; }
        .concentric-circle { display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #000; transition: background-color 0.3s ease; }
        #preview-orb { width: 110px; height: 110px; border-radius: 50%; border: 4px solid #000; position: relative; margin: 0 auto; transition: all 0.3s; }
        .orb-original { box-shadow: none; }
        .orb-matt { box-shadow: inset -12px -12px 30px rgba(0,0,0,0.5), inset 8px 8px 15px rgba(255,255,255,0.2); }
        .orb-metallic { box-shadow: inset -8px -8px 25px rgba(0,0,0,0.8), inset 4px 4px 8px rgba(255,255,255,0.7); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-black">

    <div id="app-container" class="w-[375px] h-[812px] bg-white brutal-card overflow-hidden flex flex-col relative border-[3px] border-black">
        
        <div id="modal-overlay">
            <div class="bg-white border-[4px] border-black p-6 w-full space-y-5">
                <h3 id="modal-title" class="font-black text-xl uppercase italic text-left">儲存專案</h3>
                <div class="space-y-2 text-left">
                    <p class="text-[10px] font-black uppercase">專案名稱 (不可重複)</p>
                    <input type="text" id="project-name-input" class="w-full p-3 border-2 border-black font-bold outline-none bg-gray-50 focus:bg-orange-50">
                </div>
                <div id="modal-buttons" class="space-y-2 pt-2"></div>
                <button onclick="closeModal()" class="w-full text-center text-xs font-bold underline py-2">取消</button>
            </div>
        </div>

        <div id="main-view" class="flex flex-col h-full">
            <header class="bg-black p-4 flex justify-between items-center shrink-0">
                <h1 class="text-2xl font-black italic text-white uppercase tracking-tighter">PAINTBENCH</h1>
                <button onclick="toggleLanguage()" class="bg-white text-black text-[10px] px-2 py-1 font-bold border-2 border-black rounded">繁中/EN</button>
            </header>

            <main class="p-4 space-y-6 overflow-y-auto flex-grow no-scrollbar bg-white">
                <section class="space-y-2">
                    <div class="flex justify-between items-end">
                        <h2 class="font-black text-sm" id="label-step1">一、 選擇色調</h2>
                        <label class="bg-black text-white text-[10px] px-2 py-1 cursor-pointer font-bold border border-black uppercase">PHOTO <input type="file" id="imageLoader" accept="image/*" class="hidden"></label>
                    </div>
                    <div class="w-full aspect-square brutal-card bg-slate-50 flex items-center justify-center overflow-hidden">
                        <img id="colorWheel" src="color_wheel.png" class="w-11/12 cursor-crosshair">
                    </div>
                </section>

                <div id="screenshot-area" class="bg-white p-2">
                    <section class="space-y-3 mb-6">
                        <h2 class="font-black text-sm text-left" id="label-effect">二、 塗裝效果</h2>
                        <div class="brutal-card p-4 bg-gray-50 text-center">
                            <div id="preview-orb" class="orb-original bg-gray-300"></div>
                            <div class="flex gap-1 mt-4">
                                <button onclick="setEffect('original')" class="flex-1 py-2 text-[9px] font-black border-2 border-black bg-black text-white uppercase">Original</button>
                                <button onclick="setEffect('matt')" class="flex-1 py-2 text-[9px] font-black border-2 border-black bg-black text-white uppercase">Matt</button>
                                <button onclick="setEffect('metallic')" class="flex-1 py-2 text-[9px] font-black border-2 border-black bg-black text-white uppercase">Metallic</button>
                            </div>
                            <div id="share-actions" class="hidden grid grid-cols-2 gap-1 mt-1">
                                <button onclick="takeScreenshot()" class="py-2 bg-black text-white text-[9px] font-black uppercase border-2 border-black">Screenshot 截圖</button>
                                <button onclick="copyShareLink()" class="py-2 bg-black text-white text-[9px] font-black uppercase border-2 border-black">Share Link 連結</button>
                            </div>
                        </div>
                    </section>

                    <section class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="font-black text-sm text-left" id="label-step2">三、 顏色列表</h2>
                            <button onclick="togglePaintBrand()" class="bg-black text-white text-[9px] px-3 py-1 font-bold border-2 border-black rounded uppercase" id="brand-toggle-btn">Citadel</button>
                        </div>
                        <div class="brutal-card p-6 bg-gray-50 flex items-center">
                            <div id="circle-base" class="w-24 h-24 concentric-circle shrink-0" style="background-color: #ddd;"> 
                                <div id="circle-layer" class="w-16 h-16 concentric-circle" style="background-color: #bbb;"> 
                                    <div id="circle-highlight" class="w-10 h-10 concentric-circle" style="background-color: #eee;"> 
                                        <div id="circle-shadow" class="w-5 h-5 concentric-circle" style="background-color: #999;"></div> 
                                    </div>
                                </div>
                            </div>
                            <div class="ml-auto space-y-4 w-32 text-left">
                                <div class="flex flex-col"><span class="text-[8px] font-bold opacity-50 uppercase" id="tag-base">BASE</span><span class="text-[10px] font-black uppercase truncate" id="p-base">-</span></div>
                                <div class="flex flex-col"><span class="text-[8px] font-bold opacity-50 uppercase" id="tag-layer">LAYER</span><span class="text-[10px] font-black uppercase truncate" id="p-layer">-</span></div>
                                <div class="flex flex-col"><span class="text-[8px] font-bold opacity-50 uppercase" id="tag-high">HIGHLIGHT</span><span class="text-[10px] font-black uppercase truncate" id="p-high">-</span></div>
                                <div class="flex flex-col"><span class="text-[8px] font-bold opacity-50 uppercase" id="tag-shdw">SHADOW</span><span class="text-[10px] font-black uppercase truncate" id="p-shdw">-</span></div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>

            <footer class="p-4 bg-white border-t-2 border-black space-y-2 shrink-0">
                <button onclick="openSaveFlow()" class="w-full py-4 bg-[#FF8C00] text-white font-black text-lg uppercase border-[3px] border-black">SAVE PROJECT</button>
                <button onclick="viewProjects()" class="w-full py-4 bg-black text-white font-black text-lg uppercase border-[3px] border-black">VIEW PROJECTS</button>
            </footer>
        </div>

        <div id="list-view" class="hidden flex flex-col h-full bg-white z-50">
            <header class="bg-black p-4 border-b-2 border-black text-center shrink-0">
                <h1 class="text-2xl font-black uppercase italic text-white">Project Library</h1>
            </header>
            <main id="list-container" class="p-4 space-y-3 overflow-y-auto flex-grow no-scrollbar bg-white"></main>
            <footer class="p-4 bg-white border-t-2 border-black shrink-0">
                <button onclick="resetToInitial()" class="w-full py-4 bg-black text-white font-black text-lg uppercase">BACK TO CREATE</button>
            </footer>
        </div>
    </div>

    <script>
        const paintLibrary = {
            Citadel: [{ name: "Mephiston Red", rgb: [154, 17, 21] }, { name: "Macragge Blue", rgb: [15, 76, 121] }, { name: "Averland Sunset", rgb: [255, 184, 0] }, { name: "Abaddon Black", rgb: [27, 27, 27] }, { name: "White Scar", rgb: [255, 255, 255] }],
            Vallejo: [{ name: "Flat Red", rgb: [173, 31, 35] }, { name: "Royal Blue", rgb: [0, 35, 102] }, { name: "Black", rgb: [1, 1, 1] }, { name: "Dead White", rgb: [242, 242, 242] }],
            AK: [{ name: "Deep Red", rgb: [128, 0, 0] }, { name: "Ice Yellow", rgb: [251, 245, 175] }, { name: "Black", rgb: [0, 0, 0] }, { name: "Titanium White", rgb: [255, 255, 255] }]
        };

        let currentBrand = "Citadel", brands = ["Citadel", "Vallejo", "AK"], currentLang = 'zh';
        let projects = JSON.parse(localStorage.getItem('PB_Final_v4')) || [];
        let currentRGB = [221, 221, 221], currentEditingIndex = -1;

        // --- 核心配色演算法：對比與相近色偏移 (Hue Shifting) ---
        // 受光面(Highlight)向黃/暖偏移，陰影面(Shadow)向藍/冷對比色偏移
        
        function updateUI(r, g, b) {
            currentRGB = [r, g, b];
            const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();

            // 1. BASE (核心主色)
            document.getElementById('circle-base').style.backgroundColor = `rgb(${r},${g},${b})`;
            
            // 2. LAYER (主題色：暖偏移) - 提高亮度，減少藍色比重使偏黃/橘相近色
            const lr = Math.min(255, r * 1.1 + 15);
            const lg = Math.min(255, g * 1.1 + 10);
            const lb = Math.max(0, b * 0.85); 
            document.getElementById('circle-layer').style.backgroundColor = `rgb(${lr},${lg},${lb})`;

            // 3. HIGHLIGHT (高光：強暖光) - 亮度最高，向淺黃白偏移
            const hr = Math.min(255, r * 1.2 + 50);
            const hg = Math.min(255, g * 1.2 + 50);
            const hb = Math.min(255, b * 1.1 + 30);
            document.getElementById('circle-highlight').style.backgroundColor = `rgb(${hr},${hg},${hb})`;

            // 4. SHADOW (陰影：冷對比) - 降低亮度，增加藍紫色比重，創造深度對比
            const sr = Math.max(0, r * 0.65 - 15);
            const sg = Math.max(0, g * 0.55 - 10);
            const sb = Math.min(255, b * 0.8 + 25); // 增加藍色位移
            document.getElementById('circle-shadow').style.backgroundColor = `rgb(${sr},${sg},${sb})`;

            updateOrbVisual(r, g, b, lr, lg, lb, hr, hg, hb, sr, sg, sb);
            updatePaintNames([r,g,b], [lr,lg,lb], [hr,hg,hb], [sr,sg,sb]);
        }

        function updateOrbVisual(r, g, b, lr, lg, lb, hr, hg, hb, sr, sg, sb) {
            const orb = document.getElementById('preview-orb');
            const isMet = orb.classList.contains('orb-metallic');
            if(isMet) {
                // 金屬渲染：高光(強白) -> 暖光 -> 主色 -> 冷陰影
                orb.style.background = `radial-gradient(circle at 30% 30%, #ffffff 0%, #ffd700 20%, rgb(${r},${g},${b}) 50%, rgb(${sr},${sg},${sb}) 100%)`;
            } else {
                // 消光渲染：受光偏移 -> 主色 -> 冷偏移
                orb.style.background = `radial-gradient(circle at 35% 35%, rgb(${hr},${hg},${hb}) 0%, rgb(${r},${g},${b}) 60%, rgb(${sr},${sg},${sb}) 100%)`;
            }
        }

        function updatePaintNames(b, l, h, s) {
            const db = paintLibrary[currentBrand];
            const find = (rgb) => {
                let min = Infinity, name = "-";
                db.forEach(p => {
                    let d = Math.sqrt((rgb[0]-p.rgb[0])**2 + (rgb[1]-p.rgb[1])**2 + (rgb[2]-p.rgb[2])**2);
                    if(d < min) { min = d; name = p.name; }
                });
                return name;
            };
            document.getElementById('p-base').innerText = find(b);
            document.getElementById('p-layer').innerText = find(l);
            document.getElementById('p-high').innerText = find(h);
            document.getElementById('p-shdw').innerText = find(s);
        }

        // --- 下方為 APP 基礎邏輯與交互 (維持原功能) ---
        function togglePaintBrand() {
            currentBrand = brands[(brands.indexOf(currentBrand)+1)%brands.length];
            document.getElementById('brand-toggle-btn').innerText = currentBrand;
            updateUI(...currentRGB);
        }

        function openSaveFlow() {
            document.getElementById('modal-overlay').style.display = 'flex';
            const btnArea = document.getElementById('modal-buttons');
            const input = document.getElementById('project-name-input');
            input.value = currentEditingIndex === -1 ? "" : projects[currentEditingIndex].name;
            btnArea.innerHTML = '';
            if(currentEditingIndex === -1) {
                btnArea.innerHTML = `<button onclick="handleSave('new')" class="w-full py-4 bg-[#FF8C00] text-white font-black uppercase border-2 border-black">儲存專案 (Save)</button>`;
            } else {
                btnArea.innerHTML = `
                    <button onclick="handleSave('overwrite')" class="w-full py-3 bg-black text-white font-black uppercase border-2 border-black">覆蓋專案 (Overwrite)</button>
                    <button onclick="handleSave('new')" class="w-full py-3 bg-white text-black font-black uppercase border-2 border-black mt-2">另存為新專案 (Save New)</button>`;
            }
        }

        function handleSave(mode) {
            const name = document.getElementById('project-name-input').value.trim();
            if(!name) return alert("請輸入名稱");
            if(projects.some((p, i) => (mode === 'new' || i !== currentEditingIndex) && p.name.toLowerCase() === name.toLowerCase())) return alert("名稱重複！");
            
            const hex = "#" + ((1 << 24) + (currentRGB[0] << 16) + (currentRGB[1] << 8) + currentRGB[2]).toString(16).slice(1).toUpperCase();
            if(mode === 'overwrite') projects[currentEditingIndex] = { name, hex, rgb: currentRGB };
            else { projects.push({ name, hex, rgb: currentRGB }); currentEditingIndex = projects.length - 1; }
            
            localStorage.setItem('PB_Final_v4', JSON.stringify(projects));
            closeModal(); alert("儲存成功！");
        }

        function viewProjects() {
            const list = document.getElementById('list-container');
            list.innerHTML = '';
            projects.forEach((p, i) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 mb-2";
                const btn = document.createElement('button');
                btn.className = "flex-grow p-4 border-2 border-black font-black uppercase text-left";
                btn.style.backgroundColor = p.hex;
                btn.style.color = (parseInt(p.hex.slice(1), 16) < 0xffffff/2) ? "white" : "black";
                btn.innerText = p.name;
                btn.onclick = () => {
                    currentRGB = p.rgb; currentEditingIndex = i;
                    updateUI(...currentRGB);
                    document.getElementById('share-actions').classList.remove('hidden');
                    backToMain();
                };
                const del = document.createElement('button');
                del.className = "w-12 border-2 border-black bg-white text-red-500 font-bold";
                del.innerText = "X";
                del.onclick = () => { projects.splice(i, 1); localStorage.setItem('PB_Final_v4', JSON.stringify(projects)); viewProjects(); };
                row.appendChild(btn); row.appendChild(del); list.appendChild(row);
            });
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('list-view').classList.remove('hidden');
        }

        function resetToInitial() {
            currentEditingIndex = -1; updateUI(221, 221, 221);
            document.getElementById('share-actions').classList.add('hidden');
            backToMain();
        }

        function backToMain() { document.getElementById('list-view').classList.add('hidden'); document.getElementById('main-view').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function setEffect(t) { const orb = document.getElementById('preview-orb'); orb.className = 'orb-' + t; updateOrbVisual(...currentRGB); }

        async function takeScreenshot() {
            const area = document.getElementById('screenshot-area');
            const cvs = await html2canvas(area, { backgroundColor: "#ffffff", scale: 2 });
            const link = document.createElement('a');
            link.download = `PaintBench-${Date.now()}.png`; link.href = cvs.toDataURL(); link.click();
        }

        function copyShareLink() { navigator.clipboard.writeText(`PB-Color: ${currentHex}`); alert("已複製連結！"); }

        // --- 初始化選色事件 ---
        const img = document.getElementById('colorWheel');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        img.onload = () => { canvas.width = img.naturalWidth; canvas.height = img.naturalHeight; ctx.drawImage(img, 0, 0); };
        img.onclick = (e) => {
            const rect = img.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (img.naturalWidth / rect.width);
            const y = (e.clientY - rect.top) * (img.naturalHeight / rect.height);
            const p = ctx.getImageData(x, y, 1, 1).data;
            currentEditingIndex = -1; updateUI(p[0], p[1], p[2]);
            document.getElementById('share-actions').classList.add('hidden');
        };
        document.getElementById('imageLoader').onchange = (e) => {
            const r = new FileReader(); r.onload = (ev) => { img.src = ev.target.result; }; r.readAsDataURL(e.target.files[0]);
        };
        function toggleLanguage() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            const zh = currentLang === 'zh';
            document.getElementById('label-step1').innerText = zh ? "一、 選擇色調" : "1. SELECT COLOR";
            document.getElementById('label-effect').innerText = zh ? "二、 塗裝效果" : "2. VISUAL EFFECT";
            document.getElementById('label-step2').innerText = zh ? "三、 顏色列表" : "3. COLOR LIST";
        }
    </script>
</body>
</html>

